name: deploy project to testFlight, playstore internal track

on:
  push:
    branches:
      - main

jobs:
  # IOS
  deploy_ios:
    runs-on: [self-hosted, macOS]
    steps:
      - uses: actions/checkout@v4

      - name: Install fastlane
        run: arch -arm64 brew install fastlane || true

      - name: Setup Flutter
        run: |
          if ! command -v flutter &> /dev/null; then
            echo "Flutter not found, please install Flutter on self-hosted runner"
            exit 1
          fi
          flutter --version

      - name: Clean and Install dependencies
        run: |
          flutter clean
          rm -rf ~/Library/Developer/Xcode/DerivedData
          rm -rf ios/Pods ios/Podfile.lock
          flutter pub get

      - name: Install CocoaPods
        run: |
          sudo arch -arm64 gem install cocoapods
          cd ios && arch -arm64 pod install --repo-update

      # 빌드 및 배포
      - name: Deploy Product to Store
        run: arch -arm64 fastlane release
        working-directory: ios
        env:
          FASTLANE_TEAM_ID: ${{ secrets.FASTLANE_TEAM_ID }}
          FASTLANE_APPLE_ID: ${{ secrets.FASTLANE_APPLE_ID }}
          FASTLANE_ITC_TEAM_ID: ${{ secrets.FASTLANE_ITC_TEAM_ID }}
          FASTLANE_PASSWORD: ${{ secrets.FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          MATCH_GIT_BASIC_AUTHORIZATION: ${{ secrets.MATCH_GIT_BASIC_AUTHORIZATION }}
          APP_STORE_CONNECT_API_KEY_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_KEY_ID }}
          APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY_KEY }}

  # AOS
  deploy_android:
    runs-on: [self-hosted, macOS]
    needs: [ deploy_ios ]
    steps:
      - uses: actions/checkout@v4

      - name: Install fastlane
        run: arch -arm64 brew install fastlane || true

      - name: Setup Flutter
        run: |
          if ! command -v flutter &> /dev/null; then
            echo "Flutter not found, please install Flutter on self-hosted runner"
            exit 1
          fi
          flutter --version

      - name: Install dependencies
        run: flutter pub get

      # upload key 복호화
      - name: Generate Android keystore
        id: android_keystore
        uses: timheuer/base64-to-file@v1.1
        with:
          fileName: key.jks
          encodedString: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}

      # key.properties 생성
      - name: Create key properties
        run: |
          echo "storeFile=${{ steps.android_keystore.outputs.filePath }}" >> android/app/key.properties
          echo "storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" >> android/app/key.properties
          echo "keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}" >> android/app/key.properties
          echo "keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}" >> android/app/key.properties

      # Google Play JSON Key 생성
      - name: Create Google Play JSON Key
        id: google_play_key
        uses: timheuer/base64-to-file@v1.1
        with:
          fileName: google-play-key.json
          encodedString: ${{ secrets.GOOGLE_PLAY_JSON_KEY_BASE64 }}

      # 빌드 및 배포
      - name: Deploy Product to Store
        run: arch -arm64 fastlane deploy
        working-directory: android
        env:
          GOOGLE_PLAY_JSON_KEY_PATH: ${{ steps.google_play_key.outputs.filePath }}
